## Partie 1 : Installation

# Installation unbound
zypper in unbound 

# Création fichier log et droits
sudo touch /var/log/unbound.log 
sudo chmod 755 /var/log/unbound.log 

# Création du répertoire unbound
sudo mkdir /var/lib/unbound 

# Changement de propriétaire du répertoire
sudo chown unbound unbound 

# Téléchargement les serveurs racines
sudo wget https://www.internic.net/domain/named.cache -O /etc/unbound/root.hints

# Téléchargement fichier Antipub dans Unbound
sudo wget -q -O- 'http://pgl.yoyo.org/adservers/serverlist.php?hostformat=unbound&showintro=0&mimetype=plaintext' > /etc/unbound/local.d/unbound_add_servers 

# Changement de propriétaire du fichier unbound_add_servers
sudo chown unbound:unbound /etc/unbound/local.d/unbound_add_servers 

# Génération des clefs TLS
unbound-control-setup 

# Désactivation dnsmasq
sudo systemctl status dnsmasq 
sudo systemctl stop dnsmasq 
sudo systemctl disable dnsmasq 
sudo killall dnsmasq 

# Désactivation résolved
sudo systemctl status systemd-resolved 
sudo systemctl stop systemd-resolved 
sudo systemctl disable systemd-resolved 

SUDO cat /etc/resolv.conf 
---------------------------------
  Generated by NetworkManager 
  nameserver :127.0.0.1
  nameserver ::1 
---------------------------------

# Création signature numérique DNSSEC
sudo -u unbound unbound-anchor -v -a /var/lib/unbound/root.key 

# Supprimer cache-DNS local / Installer nscd
sudo zypper in nscd 
sudo systemctl restart nscd 

--------------------------------------------------
##### TELECHARCHER LE FICHIER CONFIGURATION #####
-------------------------------------------------

# Rechargement Unbound
sudo systemctl restart unbound 

# Rechargement Networkmanager
sudo systemctl restart NetworkManager 

# Lancement unbound au démarrage
sudo systemctl enable unbound 

# Voir le status d'unbound et les erreurs
sudo systemctl status unbound 

# Divers Tests de Fonctionnement unbound
sudo unbound-checkconf /etc/unbound/unbound.conf 
sudo unbound-checkconf: no errors in /etc/unbound/unbound.conf
sudo dig com. SOA +dnssec
sudo unbound-host com. -f /var/lib/unbound/root.key -v 
sudo unbound-host dnssec.cz -f /var/lib/unbound/root.key -v 
sudo unbound-host dnssec.cz -C /etc/unbound/unbound.conf -v 

--------------------------------------------------------------------
localhost:/ # unbound-host com. -f /var/lib/unbound/root.key -v
com. has no address (secure)
com. has no IPv6 address (secure)
com. has no mail handler record (secure)
localhost:/ # unbound-host dnssec.cz -f /var/lib/unbound/root.key -v
dnssec.cz has address 217.31.205.51 (secure)
dnssec.cz has IPv6 address 2001:1488:0:3::5 (secure)
dnssec.cz mail is handled by 10 mail.nic.cz. (secure)
dnssec.cz mail is handled by 15 mx.nic.cz. (secure)
localhost:/ # unbound-host dnssec.cz -C /etc/unbound/unbound.conf -v
dnssec.cz has address 217.31.205.51 (secure)
dnssec.cz has IPv6 address 2001:1488:0:3::5 (secure)
dnssec.cz mail is handled by 10 mail.nic.cz. (secure)
dnssec.cz mail is handled by 15 mx.nic.cz. (secure)
------------------------------------------------------------------------

sudo dig +nodnssec +short TXT qnamemintest.internet.nl 
----------------------------------------------------------------
localhost:/ # dig +nodnssec +short TXT qnamemintest.internet.nl 
a.b.qnamemin-test.internet.nl.
"HOORAY - QNAME minimisation is enabled on your resolver :)!"
----------------------------------------------------------------

# Vérification boucle locale DNS
sudo nmcli dev show | grep DNS 

# Vérification unique résolveur dns dans le système (uniquement résolveur Undound)
sudo lsof -i :53  

# Vérification port d'écoute unbound tcp & udp
sudo ss -laputen | grep unbound 

# Analyse stats d'Unbound
sudo unbound-control stats 
